(window.webpackJsonp=window.webpackJsonp||[]).push([[109],{401:function(e,t,n){"use strict";n.r(t);var a=n(4),s=Object(a.a)({},(function(){var e=this,t=e._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h2",{attrs:{id:"koa实践总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#koa实践总结"}},[e._v("#")]),e._v(" Koa实践总结")]),e._v(" "),t("blockquote",[t("p",[t("a",{attrs:{href:"https://mp.weixin.qq.com/s/siGxYq7TvcD3g580BZJkRw",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://mp.weixin.qq.com/s/siGxYq7TvcD3g580BZJkRw"),t("OutboundLink")],1)])]),e._v(" "),t("h2",{attrs:{id:"为什么选择-koa"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么选择-koa"}},[e._v("#")]),e._v(" 为什么选择 Koa")]),e._v(" "),t("p",[e._v("小王：为什么选择"),t("code",[e._v("Koa")]),e._v("?\n老王：因为 Koa 比较"),t("code",[e._v("轻量")]),e._v("，几乎没有内置任何的额外功能。也是因为这个原因，Koa 的"),t("code",[e._v("灵活度")]),e._v("是很高的，喜欢折腾的人可以尝试下\n小王：又轻量又几乎没有任何额外功能？那为什么不用原生"),t("code",[e._v("Node")]),e._v("？那个不是更轻？\n老王：这个。。。。 我还是先说说怎么用吧")]),e._v(" "),t("blockquote",[t("p",[e._v("有点长，心急的可以查看完整代码  https://github.com/JustGreenHand/koa-app")])]),e._v(" "),t("h2",{attrs:{id:"搭建项目并启动服务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#搭建项目并启动服务"}},[e._v("#")]),e._v(" 搭建项目并启动服务")]),e._v(" "),t("p",[e._v("经过一系列基操之后，生成如下所示的目录结构："),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0ptkwkREsOqaftBbqbFnTCLOfQF6nfSgnAXcpGy3qnQdk3Vkl5FRlgw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("接下来我们在启动文件 "),t("code",[e._v("app/index.js")]),e._v(" 文件中写入最简单的启动服务代码:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Koa = require('koa');\n\nconst app = new Koa();\n\nconst port = '8082'\nconst host = '0.0.0.0'\n\napp.use(async ctx => {\n  ctx.body = 'Hello World';\n});\n\napp.listen(port, host, () => {\n  console.log(`API server listening on ${host}:${port}`);\n});\n")])])]),t("p",[e._v("我们运行一下 "),t("code",[e._v("node app/index.js")]),e._v(" 命令，这个时候，最简单的 node 服务已经启动起来了。浏览器里访问 "),t("code",[e._v("http://localhost:8082")]),e._v(" 已经可以正常响应了")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0JmLVldHXIGl2kp9tBd9SbnkZibZIzMm3nWWqPWTTDpHBnhLouDoic3qg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[t("img",{attrs:{src:"http://mmbiz.qpic.cn/mmbiz_png/jQmwTIFl1V0dLQzNJW15CVaCoNjposvTpccciaj05o5nPiaqfLRRfTQiaYFYPN41Etrrqt8jPOWukPmJWt3lYxwuA/0?wx_fmt=png",alt:"全栈修仙之路"}})]),e._v(" "),t("p",[t("strong",[e._v("全栈修仙之路")])]),e._v(" "),t("p",[e._v("专注分享 TS、Vue3、前端架构和源码解析等技术干货。")]),e._v(" "),t("p",[e._v("125篇原创内容")]),e._v(" "),t("p",[e._v("公众号")]),e._v(" "),t("h2",{attrs:{id:"改造路由"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#改造路由"}},[e._v("#")]),e._v(" 改造路由")]),e._v(" "),t("p",[e._v("当项目功能慢慢多起来的时候，路由处理也相应的多了起来，"),t("code",[e._v("app/index.js")]),e._v(" 代码就成了下面这样：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Koa = require('koa');\n\nconst app = new Koa();\n\nconst port = '8082'\nconst host = '0.0.0.0'\n\napp.use(async ctx => {\n  const { path } = ctx\n  if (path === '/a') {\n    // 功能 A\n    ctx.body = 'a';\n  } else if (path === '/b') {\n    // 功能 B\n    ctx.body = 'b';\n  } else if (path === '/c') {\n    // 功能 C\n    ctx.body = 'c';\n  } else {\n    ctx.body = 'hello world'\n  }\n});\n\napp.listen(port, host, () => {\n  console.log(`API server listening on ${host}:${port}`);\n});\n")])])]),t("p",[e._v("这种将所有路由和路由处理函数写在一起的方式，后期会难以维护，代码量长了容易找不到重点。所以我们将路由处理的部分从启动文件 "),t("code",[e._v("app/index.js")]),e._v(" 里摘出来，单独维护一个路由文件，并用第三方路由管理插件"),t("code",[e._v("koa-router")]),e._v(" 来管理路由。我们在 "),t("code",[e._v("app")]),e._v(" 目录下新建 "),t("code",[e._v("router")]),e._v(" 目录，如下所示:")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0QZUvB5ibfm68W8IgK4ITF9WRYTZvOjOS5PNIAEbM6g39XXYExHhsegw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("首先我们安装下路由处理插件( koa-ruoter 文档 ): "),t("code",[e._v("npm install koa-router -s")]),e._v(", 再在 "),t("code",[e._v("app/router/index.js")]),e._v(" 文件中编写路由处理部分的代码")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const koaRouter = require('koa-router');\nconst router = new koaRouter();\n\nrouter.get('/a', ctx => {\n  ctx.body = 'a'\n});\n\nrouter.get('/b', ctx => {\n  ctx.body = 'b'\n});\n\nrouter.get('/c', ctx => {\n  ctx.body = 'c'\n});\n\nmodule.exports = router;\n")])])]),t("p",[e._v("修改 "),t("code",[e._v("app/index.js")]),e._v(" 的代码，路由处理从 "),t("code",[e._v("app/router/index.js")]),e._v(" 文件引入:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Koa = require('koa');\n\nconst router = require('./router')\n\nconst app = new Koa();\n\nconst port = '8082'\nconst host = '0.0.0.0'\n\napp.use(router.routes());\n/*\n    原先当路由存在，请求方式不匹配的时候，会报 404，\n    加了这个中间件，会报请求方式不被允许\n*/\napp.use(router.allowedMethods());\n\n\napp.listen(port, host, () => {\n  console.log(`API server listening on ${host}:${port}`);\n});\n")])])]),t("p",[e._v("尝试访问 "),t("code",[e._v("http://localhost:8082/a")]),e._v(" 返回结果与改造前一致。到这里为止，各个文件看起来是各司其职，功能拆分比较明确的。但是当接口越来越多的时候，我们的路由处理文件还是会越来越庞大，我们的目标是路由处理文件只关心路由的处理，具体业务逻辑不关心。所以这里再次将路由处理文件进行任务拆分。")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO07hLZUfhulGQ2nXm5ickJPtOe7gNmlzCPe0xlvAkc4YcxpKdjBze5qnQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("如上图，这个阶段我们新增了三个文件")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("app/router/routes.js")]),e._v("    路由列表文件")]),e._v(" "),t("li",[t("code",[e._v("app/contronllers/index.js")]),e._v(" 业务处理统一导出")]),e._v(" "),t("li",[t("code",[e._v("app/contronllers/test.js")]),e._v("  业务处理文件")])]),e._v(" "),t("p",[e._v("将各业务逻辑的代码放在 controllers 下，示例文件 "),t("code",[e._v("app/contronllers/test.js")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const list = async ctx => {\n  ctx.body = '路由改造后的结果'\n}\n\nmodule.exports = {\n  list\n}\n")])])]),t("p",[e._v("将这部分业务处理代码导入到 "),t("code",[e._v("app/contronllers/index.js")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const test = require('./test');\n\nmodule.exports = {\n  test\n};\n")])])]),t("p",[e._v("这样的好处是所有业务处理统一一个入口，利于维护。接下来编写文件 "),t("code",[e._v("app/router/routes.js")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const { test } = require('../controllers');\n\nconst routes = [\n  {\n    //  测试\n    method: 'get',\n    path: '/a',\n    controller: test.list\n  }\n];\n\nmodule.exports = routes;\n")])])]),t("p",[e._v("这个时候，原本的 "),t("code",[e._v("app/router/index.js")]),e._v(" 文件也需要做相应的修改了:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("/* const Router = require('koa-router');\nconst router = new Router();\n\nrouter.get('/a', ctx => {\n  ctx.body = 'a'\n});\n\nrouter.get('/b', ctx => {\n  ctx.body = 'b'\n});\n\nrouter.get('/c', ctx => {\n  ctx.body = 'c'\n});\n\nmodule.exports = router; */\n\n\nconst koaRouter = require('koa-router');\nconst router = new koaRouter();\n\nconst routeList = require('./routes');\n\nrouteList.forEach(item => {\n  const { method, path, controller } = item;\n  //  router 第一个参数是 path， 后面跟上路由级中间件 controller（上面编写的路由处理函数）\n  router[method](path, controller);\n});\n\nmodule.exports = router;\n")])])]),t("p",[e._v("经过上面的改造后，再次访问下 "),t("code",[e._v("http://localhost:8082/a")]),e._v("，返回结果:")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0jblgwV4wz3nQg1U9bgbI7AVVf01SkNVRibESvElJM80LFOY0kJHg6Jg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("看起来没啥问题，到这里为止路由改造已经完成，而且顺便把启动文件，路由文件，路由处理文件三部分拆开了")]),e._v(" "),t("h2",{attrs:{id:"参数解析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参数解析"}},[e._v("#")]),e._v(" 参数解析")]),e._v(" "),t("p",[e._v("一番实际操作后，发现 post 请求时，拿不到 "),t("code",[e._v("body")]),e._v(" 里的参数。如下截图:"),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0aMJoL6KdcibHolg1quCrmuXrdddJAu2LIYwLzbJQtygrMjGEbokN5SQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),e._v("\n期望的返回值为 "),t("code",[e._v('{"a": 4}')]),e._v(", 实际为:"),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0defR9BF7NxXvCPr1omGC0ra9FfU5ialE0LicUuEE17wC2asdxske7sXg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("翻阅资料后这里需要加上一个参数解析的中间件。考虑到后面可能会添加更多的中间件，在具体处理参数之前，先将当前的代码再次进行改造下，将中间件处理单独从启动文件 "),t("code",[e._v("app/index.js")]),e._v(" 里摘出来，新建一个  "),t("code",[e._v("app/middlewares")]),e._v(" 目录，在该目录中我们添加 "),t("code",[e._v("index.js")]),e._v(" 文件:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const router = require('../router');\n\n/**\n * 路由处理\n */\nconst mdRoute = router.routes();\nconst mdRouterAllowed = router.allowedMethods();\n\nmodule.exports = [\n  mdRoute,\n  mdRouterAllowed\n];\n")])])]),t("p",[e._v("上面文件里集中了所有用到的中间件，目前为止是两个路由处理的中间件，接下来改造下启动文件 "),t("code",[e._v("app/index.js")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Koa = require('koa');\n\nconst compose = require('koa-compose');\nconst MD = require('./middlewares/');\n\nconst app = new Koa();\n\nconst port = '8082'\nconst host = '0.0.0.0'\n\napp.use(compose(MD));\n\napp.listen(port, host, () => {\n  console.log(`API server listening on ${host}:${port}`);\n});\n")])])]),t("p",[e._v("这里引入了一个插件 koa-compose，作用是简化引用中间件的写法。到这里准备工作已经做好了，开始处理参数解析的问题")]),e._v(" "),t("p",[e._v("安装第三方参数解析插件 koa-bodyparser 来帮我们处理 post 请求体中的参数。修改 "),t("code",[e._v("app/middlewares/index.js")]),e._v(" 文件:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const koaBody = require('koa-bodyparser');\n\nconst router = require('../router');\n\n/**\n * 参数解析\n * https://github.com/koajs/bodyparser\n */\nconst mdKoaBody = koaBody({\n  enableTypes: [ 'json', 'form', 'text', 'xml' ],\n  formLimit: '56kb',\n  jsonLimit: '1mb',\n  textLimit: '1mb',\n  xmlLimit: '1mb',\n  strict: true\n});\n\n/**\n * 路由处理\n */\nconst mdRoute = router.routes();\nconst mdRouterAllowed = router.allowedMethods();\n\nmodule.exports = [\n  mdKoaBody,\n  mdRoute,\n  mdRouterAllowed\n];\n")])])]),t("p",[e._v("因为我们已经改造过启动文件了，所以不需要在启动文件里再添加 "),t("code",[e._v("app.use()")]),e._v(" 了。这里再次尝试用 post 请求:"),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO05ic3QDc45Ce74aCRj1t0muF2X9BKZibQiaJ6HuaTFt8mCgBOaJnolibdMA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("发现已经是我们的预期结果了。不过这里还是有个坑:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const mdKoaBody = koaBody({\n  enableTypes: [ 'json', 'form', 'text', 'xml' ],\n  formLimit: '56kb',\n  jsonLimit: '1mb',\n  textLimit: '1mb',\n  xmlLimit: '1mb',\n  strict: true\n});\n")])])]),t("p",[e._v("从这段代码可以稍微看出，"),t("code",[e._v("koa-bodyparser")]),e._v(" 这个插件只能解析 4 种数据"),t("code",[e._v("[ 'json', 'form', 'text', 'xml' ]")]),e._v("，当我们上传文件的时候，我们是获取不到文件的。秉持自己不会造可以白嫖绝不自己造轮子的原则，我们又在网上找到了解决方法，引入新的插件 "),t("code",[e._v("formidable")]),e._v("，由于这部分代码稍微有点多，所以我们在 "),t("code",[e._v("app/middlewares")]),e._v(" 目录下再单独新建一个 "),t("code",[e._v("formidable.js")]),e._v(" 文件，代码如下:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Formidable = require('formidable');\n\nconst { tempFilePath } = require('../config');\n\nmodule.exports = () => {\n  return async function (ctx, next) {\n    const form = new Formidable({\n      multiples: true, \n      //  上传的临时文件保存路径\n      uploadDir: `${process.cwd()}/${tempFilePath}`\n    });\n\n    // eslint-disable-next-line promise/param-names\n    await new Promise((reslove, reject) => {\n      form.parse(ctx.req, (err, fields, files) => {\n        if (err) {\n          reject(err);\n        } else {\n          ctx.request.body = fields;\n          ctx.request.files = files;\n          reslove();\n        }\n      });\n    });\n\n    await next();\n  };\n};\n")])])]),t("p",[e._v("formidable 具体用法就不解释了，有兴趣的可以 查看文档，这里，我们将写好的中间件在 "),t("code",[e._v("app/middlewares/index.js")]),e._v(" 中使用:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("/**\n * 引入第三方插件\n */\nconst koaBody = require('koa-bodyparser');\n\n/**\n * 引入自定义文件\n */\nconst router = require('../router');\nconst formidable = require('./formidable');\n\n/**\n * 参数解析\n * https://github.com/koajs/bodyparser\n */\nconst mdFormidable = formidable();\nconst mdKoaBody = koaBody({\n  enableTypes: [ 'json', 'form', 'text', 'xml' ],\n  formLimit: '56kb',\n  jsonLimit: '1mb',\n  textLimit: '1mb',\n  xmlLimit: '1mb',\n  strict: true\n});\n\n/**\n * 路由处理\n */\nconst mdRoute = router.routes();\nconst mdRouterAllowed = router.allowedMethods();\n\nmodule.exports = [\n  mdFormidable,\n  mdKoaBody,\n  mdRoute,\n  mdRouterAllowed\n];\n")])])]),t("p",[e._v("写到这里应该是可以了，我们来测试下：")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0tF7IB7qBuicrsiab06pQwQgBEEefJBTPsSWPJ7HtP2DalyDlW7IWCKPw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}}),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0T6CBXNM42MCCiaI6smiawOGibGUJ5GjVvjTP9Yv07COGHJcEfia4Gwx3nw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("从结果看出，我们的期望结果已经拿到了。到这里，参数解析算是处理好了")]),e._v(" "),t("blockquote",[t("p",[e._v("补充下 "),t("code",[e._v("formidable.js")]),e._v(" 文件中使用的  "),t("code",[e._v("const { tempFilePath } = require('../config')")]),e._v("。这里我们新加了个配置目录 "),t("code",[e._v("app/config")]),e._v("，主要用来存在各种配置，目录下有 5 个文件，分别是:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("app/config/index.js")])]),e._v(" "),t("li",[t("code",[e._v("app/config/base.js")])]),e._v(" "),t("li",[t("code",[e._v("app/config/dev.js")])]),e._v(" "),t("li",[t("code",[e._v("...")]),e._v("除了"),t("code",[e._v("index.js")]),e._v(" 文件，其他文件可以根据项目的实际情况来创建")])]),e._v(" "),t("p",[e._v("这里主要看下 "),t("code",[e._v("app/config/index.js")]),e._v(" 文件:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const base = require('./base');\nconst dev = require('./dev');\nconst pre = require('./pre');\nconst pro = require('./pro');\n\nconst env = process.env.NODE_ENV || 'dev';\n\nconst configMap = {\n  dev,\n  pre,\n  pro\n}\n\n\nmodule.exports = Object.assign(base, configMap[env]);\n")])])])]),e._v(" "),t("h2",{attrs:{id:"统一返回格式-错误处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#统一返回格式-错误处理"}},[e._v("#")]),e._v(" 统一返回格式 & 错误处理")]),e._v(" "),t("p",[e._v("在实现错误处理和统一返回格式之前，我们再做一点小小的改造。前面我们创建了 config 目录，里面存了一些常量配置，接下来我们还会创建一个 "),t("code",[e._v("common/utils.js")]),e._v(" 用来存放工具函数，如果每个引用到的地方都 "),t("code",[e._v("require")]),e._v(" 来引入是比较麻烦的，所以我们把工具函数和常量配置放到 "),t("code",[e._v("app.context")]),e._v(" 的属性上，之后就不用频繁引入了，可以通过 "),t("code",[e._v("ctx.")]),e._v("来访问，改造 "),t("code",[e._v("app/index.js")]),e._v(" 如下:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Koa = require('koa');\nconst compose = require('koa-compose');\n\nconst MD = require('./middlewares/');\nconst config = require('./config')\nconst utils = require('./common/utils')\n\nconst app = new Koa();\n\nconst port = '8082'\nconst host = '0.0.0.0'\n\napp.context.config = config;\napp.context.utils = utils;\n\napp.use(compose(MD));\n\napp.listen(port, host, () => {\n  console.log(`API server listening on ${host}:${port}`);\n});\n")])])]),t("p",[e._v("接下来开始正题，先来搞定统一返回格式的问题。这个第一反应就是写个工具函数，不要太简单:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const successRes = (data, msg) => {\n    return {\n        code: 0,\n        data,\n        msg: msg || 'success',\n    }\n}\nconst failRes = (code = 1, data, msg) => {\n    return {\n        code,\n        data,\n        msg: msg || 'fail',\n    }\n}\n\nctx.body = ctx.utils.successRes('aaa')\n//  或\nctx.body = ctx.utils.failRes(10001)\n")])])]),t("p",[e._v("这么写也没有问题，但是其实可以更加纯粹点，充分利用 koa 洋葱模型的优势，让 "),t("code",[e._v("ctx.body")]),e._v(" 更加简洁，返回的就是正确的结果，如: "),t("code",[e._v("ctx.body = data")]),e._v("，想到这里，那还是添加中间件了。这里需要加两个，一个错误处理，一个统一返回格式，这两个是相关联的，所以在一起写了")]),e._v(" "),t("p",[e._v("文件 "),t("code",[e._v("app/middlewares/response.js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const response = () => {\n  return async (ctx, next) => {\n    ctx.res.fail = ({ code, data, msg }) => {\n      ctx.body = {\n        code,\n        data,\n        msg,\n      };\n    };\n\n    ctx.res.success = msg => {\n      ctx.body = {\n        code: 0,\n        data: ctx.body,\n        msg: msg || 'success',\n      };\n    };\n\n    await next();\n  };\n};\n\nmodule.exports = response;\n")])])]),t("p",[e._v("文件 "),t("code",[e._v("app/middlewares/error.js")])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const error = () => {\n  return async (ctx, next) => {\n    try {\n      await next();\n      if (ctx.status === 200) {\n        ctx.res.success();\n      }\n    } catch (err) {\n      if (err.code) {\n        // 自己主动抛出的错误\n        ctx.res.fail({ code: err.code, msg: err.message });\n      } else {\n        // 程序运行时的错误\n        ctx.app.emit('error', err, ctx);\n      }\n    }\n  };\n};\n\nmodule.exports = error;\n")])])]),t("p",[e._v("在 "),t("code",[e._v("app/middlewares/index.js")]),e._v(" 文件中引入上面的两个中间件:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("/**\n * 引入第三方插件\n */\nconst koaBody = require('koa-bodyparser');\n\n/**\n * 引入自定义文件\n */\nconst router = require('../router');\nconst formidable = require('./formidable');\nconst response = require('./response');\nconst error = require('./error');\n\n/**\n * 参数解析\n * https://github.com/koajs/bodyparser\n */\nconst mdFormidable = formidable();\nconst mdKoaBody = koaBody({\n  enableTypes: [ 'json', 'form', 'text', 'xml' ],\n  formLimit: '56kb',\n  jsonLimit: '1mb',\n  textLimit: '1mb',\n  xmlLimit: '1mb',\n  strict: true\n});\n\n/**\n * 统一返回格式\n */\nconst mdResHandler = response();\n/**\n * 错误处理\n */\nconst mdErrorHandler = error();\n\n/**\n * 路由处理\n */\nconst mdRoute = router.routes();\nconst mdRouterAllowed = router.allowedMethods();\n\nmodule.exports = [\n  mdFormidable,\n  mdKoaBody,\n  mdResHandler,\n  mdErrorHandler,\n  mdRoute,\n  mdRouterAllowed\n];\n")])])]),t("p",[e._v("从这里看出，我们所有的返回值是在 "),t("code",[e._v("app/middlewares/error.js")]),e._v(" 里拦截了一下，如果状态码是 200，用成功的工具函数包装返回，如果不是则又分为两种情况：一种是我们自己抛出的，包含业务错误码的情况(这种情况我们用失败的工具函数包装返回)；另一种是程序运行时报的错，这个往往是我们代码写的有问题(这种情况我们触发 koa 的错误处理事件去处理)，针对失败的第二种情况，我们还需要修改启动文件 "),t("code",[e._v("app/index.js")]),e._v("，添加如下代码:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("app.on('error', (err, ctx) => {\n  if (ctx) {\n    ctx.body = {\n      code: 9999,\n      message: `程序运行时报错：${err.message}`\n    };\n  }\n});\n")])])]),t("p",[e._v("完成上面的操作之后我们再来测试下我们的代码: 当 "),t("code",[e._v("app/controllers/test.js")]),e._v(" 中代码如下时:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const list = async ctx => {\n  ctx.body = '返回结果'\n}\n")])])]),t("p",[e._v("请求接口，返回值如下:"),t("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),t("p",[e._v("符合我们的预期")]),e._v(" "),t("p",[e._v("接下来我们修改 "),t("code",[e._v("app/controllers/test.js")]),e._v("， 业务中抛出业务错误码")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const list = async ctx => {\n  const data = ''\n  ctx.utils.assert(data, ctx.utils.throwError(10001, '验证码失效'))\n  ctx.body = '返回结果'\n}\n")])])]),t("p",[e._v("再次返送请求，结果如下:"),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0ZZRaqHSDpNWTFZcZnK3VLCpNjZb0cuSmrrzRqU3qRRib0w5gY1zK4Fg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("符合预期")]),e._v(" "),t("p",[e._v("再次修改 "),t("code",[e._v("app/controllers/test.js")]),e._v(" 故意写错代码")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const list = async ctx => {\n  const b = a;\n  ctx.body = '返回结果'\n}\n")])])]),t("p",[e._v("再次发送请求看下结果:"),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0AibPoNdOEa2voqqGOeFZdZrO5x4lO2xjN9KCHo4SKtZQnpTAbypw0Uw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("p",[e._v("符合预期")]),e._v(" "),t("p",[e._v("到这为止，错误处理搞定了，统一返回格式也搞定了，可以搞其他的了")]),e._v(" "),t("h2",{attrs:{id:"跨域设置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#跨域设置"}},[e._v("#")]),e._v(" 跨域设置")]),e._v(" "),t("p",[e._v("这个应该是最简单的了，直接使用插件 "),t("code",[e._v("@koa/cors")]),e._v(" (查看文档)，因为这个代码量比较少，所以直接在文件 "),t("code",[e._v("app/middlewares/index.js")]),e._v(" 里添加内容:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const cors = require('@koa/cors');\n\n/**\n * 跨域处理\n */\nconst mdCors = cors({\n  origin: '*',\n  credentials: true,\n  allowMethods: [ 'GET', 'HEAD', 'PUT', 'POST', 'DELETE', 'PATCH' ]\n});\n\nmodule.exports = [\n  mdFormidable,\n  mdKoaBody,\n  mdCors,\n  mdResHandler,\n  mdErrorHandler,\n  mdRoute,\n  mdRouterAllowed\n];\n")])])]),t("p",[e._v("大功告成")]),e._v(" "),t("h2",{attrs:{id:"添加日志"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加日志"}},[e._v("#")]),e._v(" 添加日志")]),e._v(" "),t("p",[e._v("这里采用 "),t("code",[e._v("log4js")]),e._v(" 查看文档 来记录请求日志，添加文件 "),t("code",[e._v("app/middlewares/log.js")]),e._v(" :")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const log4js = require('log4js');\nconst { outDir, flag, level } = require('../config').logConfig;\n\nlog4js.configure({\n  appenders: { cheese: { type: 'file', filename: `${outDir}/receive.log` } },\n  categories: { default: { appenders: [ 'cheese' ], level: 'info' } },\n  pm2: true\n});\n\nconst logger = log4js.getLogger();\nlogger.level = level;\n\nmodule.exports = () => {\n  return async (ctx, next) => {\n    const { method, path, origin, query, body, headers, ip } = ctx.request;\n    const data = {\n      method,\n      path,\n      origin,\n      query,\n      body,\n      ip,\n      headers\n    };\n    await next();\n    if (flag) {\n      const { status, params } = ctx;\n      data.status = status;\n      data.params = params;\n      data.result = ctx.body || 'no content';\n      if (ctx.body.code !== 0) {\n        logger.error(JSON.stringify(data));\n      } else {\n        logger.info(JSON.stringify(data));\n      }\n    }\n  };\n};\n")])])]),t("p",[e._v("在 "),t("code",[e._v("app/middlewares/index.js")]),e._v(" 中引入上面写的日志中间件:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const log = require('./log');\n\n/**\n * 记录请求日志\n */\nconst mdLogger = log();\n\nmodule.exports = [\n  mdFormidable,\n  mdKoaBody,\n  mdCors,\n  mdLogger,\n  mdResHandler,\n  mdErrorHandler,\n  mdRoute,\n  mdRouterAllowed\n];\n")])])]),t("p",[e._v("我们看下请求效果:"),t("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/Tmczbd3NL038686AOs3WG5iaFbZGUoPO0XEHWDDDqX991r3Dic8w2MwM8fgR7bqia33r0dGnBicU2BqYaPFQ4ME0PQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"图片"}})]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('[2021-03-31T21:44:40.919] [INFO] default - {"method":"GET","path":"/a","origin":"http://localhost:8082","query":{"name":"张三","age":"12"},"body":{},"ip":"127.0.0.1","headers":{"user-agent":"PostmanRuntime/7.26.8","accept":"*/*","cache-control":"no-cache","postman-token":"d8be0c95-10f6-438c-aa37-1006be317081","host":"localhost:8082","accept-encoding":"gzip, deflate, br","connection":"keep-alive"},"status":200,"params":{},"result":{"code":0,"data":"返回结果","msg":"success"}}\n[2021-03-31T21:54:55.595] [ERROR] default - {"method":"GET","path":"/a","origin":"http://localhost:8082","query":{"name":"张三","age":"12"},"body":{},"ip":"127.0.0.1","headers":{"user-agent":"PostmanRuntime/7.26.8","accept":"*/*","cache-control":"no-cache","postman-token":"86b581e4-07cf-4b04-9b01-5e56c19f696f","host":"localhost:8082","accept-encoding":"gzip, deflate, br","connection":"keep-alive"},"status":200,"params":{},"result":{"code":9999,"message":"程序运行时报错：b is not defined"}}\n')])])]),t("p",[e._v("到这里日志模块也好了。")]),e._v(" "),t("h2",{attrs:{id:"参数校验"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参数校验"}},[e._v("#")]),e._v(" 参数校验")]),e._v(" "),t("p",[e._v("前面忘记了对参数做校验，不管是业务逻辑上的需要，还是为了避免程序运行时的错误，参数校验是非常有必要的。还是那句话，我们可以把参数校验放在对应的 controller 里去做，类似这样:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const list = async ctx => {\n  const { name, age } = ctx.request.query\n  if (!name) ctx.utils.assert(false, ctx.utils.throwError(10001, 'name 是必须的'))\n  if (!age) ctx.utils.assert(false, ctx.utils.throwError(10001, 'age 是必须的'))\n  ctx.body = name + age\n}\n")])])]),t("p",[e._v("但是当参数较多时，controller 会显得非常庞大，而且我们一眼看不到这个函数的重点，而且我要写很多重复的没用的代码，类似 "),t("code",[e._v("ctx.utils.assert(false, ctx.utils.throwError(10001, 'name 是必须的'))")]),e._v(" ，我希望我在 controller 层一上来就能写一些业务代码，最合理的还是将参数校验放在中间件中去统一处理，这里我们采用第三方插件 "),t("code",[e._v("@hapi/joi")]),e._v(" 来处理，在 "),t("code",[e._v("app/middlewares/")]),e._v(" 下添加 "),t("code",[e._v("paramValidator.js")]),e._v(" 文件：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("module.exports = paramSchema => {\n  return async function (ctx, next) {\n    let body = ctx.request.body;\n    try {\n      if (typeof body === 'string' && body.length) body = JSON.parse(body);\n    } catch (error) {}\n    const paramMap = {\n      router: ctx.request.params,\n      query: ctx.request.query,\n      body\n    };\n\n    if (!paramSchema) return next();\n\n    const schemaKeys = Object.getOwnPropertyNames(paramSchema);\n    if (!schemaKeys.length) return next();\n\n    // eslint-disable-next-line array-callback-return\n    schemaKeys.some(item => {\n      const validObj = paramMap[item];\n\n      const validResult = paramSchema[item].validate(validObj, {\n        allowUnknown: true\n      });\n\n      if (validResult.error) {\n        ctx.utils.assert(false, ctx.utils.throwError(9998, validResult.error.message));\n      }\n    });\n    await next();\n  };\n};\n")])])]),t("p",[e._v("这次这个参数校验中间件我们不在 "),t("code",[e._v("app/middlewares/index.js")]),e._v(" 中使用， 我们改造下 "),t("code",[e._v("app/router/index.js")]),e._v(":")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("// const koaRouter = require('koa-router');\n// const router = new koaRouter();\n\n// const routeList = require('./routes');\n\n\n// routeList.forEach(item => {\n//   const { method, path, controller } = item;\n//   router[method](path, controller);\n// });\n\n// module.exports = router;\n\nconst koaRouter = require('koa-router');\nconst router = new koaRouter();\n\nconst routeList = require('./routes');\nconst paramValidator = require('../middlewares/paramValidator');\n\nrouteList.forEach(item => {\n  const { method, path, controller, valid } = item;\n  router[method](path, paramValidator(valid), controller);\n});\n\nmodule.exports = router;\n")])])]),t("p",[t("code",[e._v("koa-router")]),e._v(" 是可以添加多个路由级中间件的，我们将参数校验放在这里处理。然后我们添加新的目录 schema，用来存放参数校验部分的代码，添加两个文件:")]),e._v(" "),t("ul",[t("li",[t("code",[e._v("app/schema/index.js")])])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const scmTest = require('./test');\n\nmodule.exports = {\n  scmTest\n};\n")])])]),t("ul",[t("li",[t("code",[e._v("app/schema/test.js")])])]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const Joi = require('@hapi/joi');\n\nconst list = {\n  query: Joi.object({\n    name: Joi.string().required(),\n    age: Joi.number().required()\n  })\n};\n\nmodule.exports = {\n  list\n};\n")])])]),t("p",[e._v("我们可以看到在 "),t("code",[e._v("app/router/index.js")]),e._v(" 中一段代码:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("  const { method, path, controller, valid } = item;\n  router[method](path, paramValidator(valid), controller);\n")])])]),t("p",[e._v("这里需要一个"),t("code",[e._v("valid")]),e._v("属性来校验参数，所以我们接着改造 "),t("code",[e._v("app/router/routes.js")]),e._v(" 文件如下:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const { test } = require('../controllers');\nconst { scmTest } = require('../schema/index')\n\nconst routes = [\n  {\n    //  测试\n    method: 'get',\n    path: '/a',\n    valid: scmTest.list,\n    controller: test.list\n  }\n];\n\nmodule.exports = routes;\n")])])]),t("p",[e._v("现在我们修改 controller 中的代码，将我们自己手动写的参数校验去掉，改成:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("const list = async ctx => {\n  const { name, age } = ctx.request.query\n  ctx.body = name + age\n}\n")])])]),t("p",[e._v("这里我们没有对参数进行校验了，我们尝试发送请求看看结果:"),t("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),t("p",[e._v("在请求参数中，我们把 "),t("code",[e._v("age")]),e._v(" 这个参数去掉了，可以看到返回结果是我们预期的，到这为止参数校验也搞定了，"),t("code",[e._v("@hapi/joi")]),e._v(" 更多的使用方法请 查看文档")]),e._v(" "),t("h2",{attrs:{id:"数据库操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据库操作"}},[e._v("#")]),e._v(" 数据库操作")]),e._v(" "),t("p",[e._v("当涉及到数据库操作时，我们可以在 app 下再新增一个 "),t("code",[e._v("service")]),e._v(" 目录。将数据库操作从 "),t("code",[e._v("controller")]),e._v(" 目录下分离出来放在 "),t("code",[e._v("service")]),e._v(" 目录下，两个目录各司其职，一个专注业务处理，一个专注数据库层面的增删改查。另外再添加一个 model 目录，用来定义数据库表结构，具体的这里暂时不介绍了。")]),e._v(" "),t("h2",{attrs:{id:"目前为止目录结构"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#目前为止目录结构"}},[e._v("#")]),e._v(" 目前为止目录结构")]),e._v(" "),t("p",[t("img",{attrs:{src:"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==",alt:"图片"}})]),e._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),t("p",[e._v("其他更多的公共逻辑都可以放在中间件层面去做，例如登录校验、权限校验等。到目前为止上面细节上还有很多问题没来得及做处理，比如统一返回格式的那个中间件，如果返回的是个文件其实会有问题，后期还会对很多细节进行优化。")]),e._v(" "),t("p",[e._v("上面是我个人总结的实践，有不合理的地方或建议大家帮忙指出来，共同学习交流进步")]),e._v(" "),t("h2",{attrs:{id:"参考资料"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考资料"}},[e._v("#")]),e._v(" 参考资料")]),e._v(" "),t("ul",[t("li",[t("p",[e._v("完整代码:")]),e._v(" "),t("p",[e._v("https://github.com/JustGreenHand/koa-app")])])])])}),[],!1,null,null,null);t.default=s.exports}}]);